<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>360db - AI Image Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-dark: #0d0d0d;
      --bg-panel: #1a1a1a;
      --bg-card: #222;
      --bg-hover: #2a2a2a;
      --text-primary: #f0f0f0;
      --text-secondary: #888;
      --accent: #8f5e38;
      --accent-light: #b17a4a;
      --success: #43bea9;
      --warning: #f5a623;
      --error: #e74c3c;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--bg-panel);
      border-bottom: 1px solid #333;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .header h1 span { color: var(--accent); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .api-key-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .api-key-input {
      padding: 10px 14px;
      border: 1px solid #444;
      border-radius: 8px;
      background: var(--bg-dark);
      color: var(--text-primary);
      font-size: 0.9rem;
      width: 280px;
    }

    .api-key-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-light);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: #444;
    }

    .btn-success {
      background: var(--success);
      color: white;
      font-size: 1.1rem;
      padding: 14px 32px;
    }

    .btn-success:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    /* Main Content */
    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }

    /* Status Panel */
    .status-panel {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .status-header h2 {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-badge.ready { background: var(--success); color: white; }
    .status-badge.analyzing { background: var(--warning); color: #000; }
    .status-badge.idle { background: var(--bg-hover); color: var(--text-secondary); }
    .status-badge.error { background: var(--error); color: white; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .stat-card {
      background: var(--bg-dark);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* Progress */
    .progress-section {
      margin-top: 25px;
      display: none;
    }

    .progress-section.active { display: block; }

    .progress-bar {
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      transition: width 0.3s;
      border-radius: 4px;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .current-image-preview {
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: var(--bg-dark);
      border-radius: 8px;
    }

    .current-image-preview img {
      width: 120px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
    }

    .current-image-info {
      flex: 1;
    }

    .current-image-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .current-image-status {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* Results Grid */
    .results-section {
      margin-top: 30px;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .results-header h2 {
      font-size: 1.3rem;
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #444;
      border-radius: 20px;
      background: transparent;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .filter-btn:hover { background: var(--bg-hover); }
    .filter-btn.active { background: var(--accent); border-color: var(--accent); }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .result-card {
      background: var(--bg-panel);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s;
    }

    .result-card:hover {
      transform: translateY(-3px);
    }

    .result-image {
      width: 100%;
      height: 160px;
      object-fit: cover;
      cursor: pointer;
    }

    .result-content {
      padding: 15px;
    }

    .result-name {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    .result-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .tag.nature { background: rgba(39, 174, 96, 0.2); color: #27ae60; }
    .tag.infrastructure { background: rgba(52, 152, 219, 0.2); color: #3498db; }
    .tag.condition { background: rgba(155, 89, 182, 0.2); color: #9b59b6; }

    .result-description {
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    /* Modal Viewer */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active { display: flex; }

    .modal-viewer {
      width: 90%;
      height: 90%;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-panel);
      border: none;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      z-index: 10;
    }

    #modal-canvas {
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }

    .modal-info {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: var(--bg-panel);
      padding: 20px;
      border-radius: 12px;
    }

    .modal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    /* Feature Category Legend */
    .legend {
      display: flex;
      gap: 20px;
      padding: 15px 20px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.85rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .legend-dot.nature { background: #27ae60; }
    .legend-dot.infrastructure { background: #3498db; }
    .legend-dot.condition { background: #9b59b6; }

    /* Log Panel */
    .log-panel {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
      max-height: 300px;
      overflow-y: auto;
    }

    .log-panel h3 {
      margin-bottom: 15px;
      font-size: 1rem;
    }

    .log-entry {
      font-family: monospace;
      font-size: 0.8rem;
      padding: 6px 0;
      border-bottom: 1px solid #333;
      display: flex;
      gap: 10px;
    }

    .log-time { color: var(--text-secondary); }
    .log-success { color: var(--success); }
    .log-error { color: var(--error); }
    .log-info { color: var(--accent); }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <h1><span>360</span>db <small style="font-weight: 400; color: var(--text-secondary); font-size: 1rem;">AI Image Analyzer</small></h1>
    <div class="header-right">
      <div class="api-key-group">
        <input type="password" class="api-key-input" id="apiKey" placeholder="OpenAI API Key (sk-...)" oninput="checkApiKey()">
      </div>
      <button class="btn btn-secondary" onclick="exportData()" id="exportBtn" disabled>Export JSON</button>
      <button class="btn btn-success" onclick="startAnalysis()" id="analyzeBtn" disabled>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        Analyze All Images
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">

    <!-- Status Panel -->
    <div class="status-panel">
      <div class="status-header">
        <h2>Analysis Status</h2>
        <span class="status-badge idle" id="statusBadge">Waiting for API Key</span>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalImages">-</div>
          <div class="stat-label">Total Images</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="analyzedCount">0</div>
          <div class="stat-label">Analyzed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalFeatures">0</div>
          <div class="stat-label">Features Found</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="estimatedTime">-</div>
          <div class="stat-label">Est. Time Left</div>
        </div>
      </div>

      <div class="progress-section" id="progressSection">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="progress-text">
          <span id="progressText">0 / 0</span>
          <span id="progressPercent">0%</span>
        </div>

        <div class="current-image-preview" id="currentPreview">
          <img id="previewImg" src="" alt="">
          <div class="current-image-info">
            <div class="current-image-name" id="previewName">-</div>
            <div class="current-image-status" id="previewStatus">Waiting...</div>
          </div>
          <button class="btn btn-secondary" onclick="pauseAnalysis()" id="pauseBtn">Pause</button>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend">
      <div class="legend-item">
        <span class="legend-dot nature"></span>
        <span>Nature / Views</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot infrastructure"></span>
        <span>Infrastructure</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot condition"></span>
        <span>Lot Conditions</span>
      </div>
    </div>

    <!-- Results -->
    <div class="results-section">
      <div class="results-header">
        <h2>Results (<span id="resultCount">0</span>)</h2>
        <div class="filter-buttons">
          <button class="filter-btn active" onclick="filterResults('all')">All</button>
          <button class="filter-btn" onclick="filterResults('nature')">Nature</button>
          <button class="filter-btn" onclick="filterResults('infrastructure')">Infrastructure</button>
          <button class="filter-btn" onclick="filterResults('condition')">Conditions</button>
        </div>
      </div>

      <div class="results-grid" id="resultsGrid">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
          </svg>
          <h3>No results yet</h3>
          <p>Enter your OpenAI API key and click "Analyze All Images" to start.</p>
        </div>
      </div>
    </div>

    <!-- Log Panel -->
    <div class="log-panel" id="logPanel" style="display: none;">
      <h3>Analysis Log</h3>
      <div id="logEntries"></div>
    </div>
  </div>

  <!-- Modal Viewer -->
  <div class="modal-overlay" id="viewerModal">
    <div class="modal-viewer">
      <button class="modal-close" onclick="closeViewer()">&times;</button>
      <canvas id="modal-canvas"></canvas>
      <div class="modal-info">
        <strong id="modalImageName">-</strong>
        <div class="modal-tags" id="modalTags"></div>
        <p id="modalDescription" style="margin-top: 10px; color: var(--text-secondary);"></p>
      </div>
    </div>
  </div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
  framesBase: 'https://andresmtzc.github.io/geepeeX/senterra/frames/',
  indexUrl: 'https://andresmtzc.github.io/geepeeX/senterra/frames/index.json'
};

// ============================================
// STATE
// ============================================
let images = [];
let analysisResults = {}; // { imageName: { features: [], description: '', analyzed: true } }
let isAnalyzing = false;
let isPaused = false;
let currentAnalysisIndex = 0;

// Three.js for modal viewer
let modalScene, modalCamera, modalRenderer, modalSphere;
let modalLon = 0, modalLat = 0, modalFov = 75;
let modalInteracting = false, modalStartX = 0, modalStartY = 0, modalStartLon = 0, modalStartLat = 0;

// ============================================
// INITIALIZATION
// ============================================
async function init() {
  await loadImages();
  loadFromLocalStorage();
  updateStats();
  renderResults();
}

async function loadImages() {
  try {
    const response = await fetch(CONFIG.indexUrl);
    const data = await response.json();
    images = data.files || [];
    document.getElementById('totalImages').textContent = images.length;
    log('Loaded ' + images.length + ' images', 'info');
  } catch (error) {
    console.error('Failed to load images:', error);
    log('Failed to load images: ' + error.message, 'error');
  }
}

// ============================================
// API KEY
// ============================================
function checkApiKey() {
  const apiKey = document.getElementById('apiKey').value;
  const analyzeBtn = document.getElementById('analyzeBtn');
  const statusBadge = document.getElementById('statusBadge');

  if (apiKey && apiKey.startsWith('sk-')) {
    analyzeBtn.disabled = false;
    statusBadge.textContent = 'Ready';
    statusBadge.className = 'status-badge ready';
  } else {
    analyzeBtn.disabled = true;
    statusBadge.textContent = 'Waiting for API Key';
    statusBadge.className = 'status-badge idle';
  }
}

// ============================================
// ANALYSIS
// ============================================
async function startAnalysis() {
  const apiKey = document.getElementById('apiKey').value;
  if (!apiKey) return;

  // Find unanalyzed images
  const unanalyzed = images.filter(img => !analysisResults[img]?.analyzed);

  if (unanalyzed.length === 0) {
    alert('All images have already been analyzed!');
    return;
  }

  isAnalyzing = true;
  isPaused = false;
  currentAnalysisIndex = 0;

  // UI updates
  document.getElementById('progressSection').classList.add('active');
  document.getElementById('logPanel').style.display = 'block';
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('statusBadge').textContent = 'Analyzing...';
  document.getElementById('statusBadge').className = 'status-badge analyzing';
  document.getElementById('pauseBtn').textContent = 'Pause';

  const startTime = Date.now();

  for (let i = 0; i < unanalyzed.length; i++) {
    if (!isAnalyzing || isPaused) break;

    currentAnalysisIndex = i;
    const imageName = unanalyzed[i];
    const imageUrl = CONFIG.framesBase + imageName;

    // Update progress UI
    updateProgressUI(i, unanalyzed.length, imageName, startTime);

    try {
      log(`Analyzing: ${imageName}`, 'info');

      const result = await analyzeImage(imageUrl, apiKey);

      analysisResults[imageName] = {
        features: result.features || [],
        description: result.overall_description || '',
        analyzed: true,
        timestamp: Date.now()
      };

      const featureCount = result.features?.length || 0;
      log(`✓ ${imageName}: Found ${featureCount} features`, 'success');

      saveToLocalStorage();
      updateStats();
      renderResults();

      // Rate limiting - wait between requests
      if (i < unanalyzed.length - 1) {
        await sleep(1500); // 1.5 seconds between requests
      }

    } catch (error) {
      log(`✗ ${imageName}: ${error.message}`, 'error');

      // If rate limited, wait longer
      if (error.message.includes('429') || error.message.includes('rate')) {
        log('Rate limited, waiting 30 seconds...', 'info');
        await sleep(30000);
        i--; // Retry this image
      }
    }
  }

  // Done
  isAnalyzing = false;
  document.getElementById('analyzeBtn').disabled = false;
  document.getElementById('statusBadge').textContent = 'Complete';
  document.getElementById('statusBadge').className = 'status-badge ready';

  if (!isPaused) {
    log('Analysis complete!', 'success');
    document.getElementById('exportBtn').disabled = false;
  }
}

function pauseAnalysis() {
  if (isPaused) {
    isPaused = false;
    document.getElementById('pauseBtn').textContent = 'Pause';
    startAnalysis(); // Resume
  } else {
    isPaused = true;
    isAnalyzing = false;
    document.getElementById('pauseBtn').textContent = 'Resume';
    document.getElementById('statusBadge').textContent = 'Paused';
    document.getElementById('statusBadge').className = 'status-badge idle';
    log('Analysis paused', 'info');
  }
}

async function analyzeImage(imageUrl, apiKey) {
  const prompt = `You are analyzing a 360° panoramic image from a rural land development in Mexico (proyecto campestre - weekend nature escape destination).

Identify ALL visible features from these specific categories:

**NATURE/VIEWS** (category: "nature"):
- mountain_view: Mountains or hills visible in distance
- open_sky: Wide open sky, good for stargazing/sunsets
- trees: Trees providing shade or natural beauty
- vegetation: Natural brush, grass, wildflowers
- rocks: Rock formations, boulders
- water: Streams, ponds, water features

**INFRASTRUCTURE** (category: "infrastructure"):
- road_paved: Paved/asphalt roads
- road_dirt: Unpaved dirt/gravel roads
- fence: Lot boundary fences
- power_lines: Electrical infrastructure
- gate: Entry gates
- signage: Lot markers, directional signs
- street_lights: Lighting infrastructure

**LOT CONDITIONS** (category: "condition"):
- flat_terrain: Level, easy-to-build areas
- sloped_terrain: Hillside or sloped areas
- shade_area: Shaded spots (good for comfort)
- neighboring_lot: Adjacent properties (built or empty)
- construction: Active construction or development
- cleared_land: Cleared/prepared building area

For each feature, provide:
1. feature: The exact feature name from above
2. category: nature, infrastructure, or condition
3. yaw: Horizontal position (-180 to 180, where 0 is center-front)
4. pitch: Vertical position (-90 to 90, where 0 is horizon)
5. confidence: How certain (0.0 to 1.0)
6. description: Brief description of what you see

Respond ONLY with valid JSON:
{
  "features": [
    { "feature": "mountain_view", "category": "nature", "yaw": 45, "pitch": 15, "confidence": 0.9, "description": "Sierra Madre mountains on horizon" },
    { "feature": "trees", "category": "nature", "yaw": -30, "pitch": 5, "confidence": 0.95, "description": "Mesquite trees along road" }
  ],
  "overall_description": "Rural lot with mountain views, unpaved road access, natural vegetation..."
}`;

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [
        {
          role: 'user',
          content: [
            { type: 'text', text: prompt },
            { type: 'image_url', image_url: { url: imageUrl, detail: 'high' } }
          ]
        }
      ],
      max_tokens: 1500,
      temperature: 0.3
    })
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error?.message || `API error: ${response.status}`);
  }

  const data = await response.json();
  const content = data.choices[0]?.message?.content || '';

  // Parse JSON from response
  const jsonMatch = content.match(/\{[\s\S]*\}/);
  if (jsonMatch) {
    return JSON.parse(jsonMatch[0]);
  }

  throw new Error('Could not parse AI response');
}

// ============================================
// UI UPDATES
// ============================================
function updateProgressUI(current, total, imageName, startTime) {
  const percent = ((current + 1) / total * 100).toFixed(1);

  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressText').textContent = `${current + 1} / ${total}`;
  document.getElementById('progressPercent').textContent = percent + '%';

  // Preview
  document.getElementById('previewImg').src = CONFIG.framesBase + imageName;
  document.getElementById('previewName').textContent = imageName;
  document.getElementById('previewStatus').textContent = 'Analyzing...';

  // Estimated time
  const elapsed = (Date.now() - startTime) / 1000;
  const perImage = elapsed / (current + 1);
  const remaining = perImage * (total - current - 1);
  const minutes = Math.ceil(remaining / 60);
  document.getElementById('estimatedTime').textContent = minutes > 0 ? `~${minutes}m` : '<1m';
}

function updateStats() {
  const analyzed = Object.values(analysisResults).filter(r => r.analyzed).length;
  const totalFeatures = Object.values(analysisResults).reduce((sum, r) => sum + (r.features?.length || 0), 0);

  document.getElementById('analyzedCount').textContent = analyzed;
  document.getElementById('totalFeatures').textContent = totalFeatures;
  document.getElementById('resultCount').textContent = analyzed;

  if (analyzed > 0) {
    document.getElementById('exportBtn').disabled = false;
  }
}

function renderResults(filter = 'all') {
  const container = document.getElementById('resultsGrid');
  const analyzed = Object.entries(analysisResults).filter(([_, r]) => r.analyzed);

  if (analyzed.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
        </svg>
        <h3>No results yet</h3>
        <p>Enter your OpenAI API key and click "Analyze All Images" to start.</p>
      </div>
    `;
    return;
  }

  // Filter results
  let filtered = analyzed;
  if (filter !== 'all') {
    filtered = analyzed.filter(([_, r]) =>
      r.features.some(f => f.category === filter)
    );
  }

  container.innerHTML = filtered.map(([imageName, result]) => {
    const features = filter === 'all'
      ? result.features
      : result.features.filter(f => f.category === filter);

    return `
      <div class="result-card">
        <img class="result-image" src="${CONFIG.framesBase}${imageName}"
             onclick="openViewer('${imageName}')"
             loading="lazy">
        <div class="result-content">
          <div class="result-name">${imageName}</div>
          <div class="result-tags">
            ${features.slice(0, 6).map(f => `
              <span class="tag ${f.category}">${formatFeature(f.feature)}</span>
            `).join('')}
            ${features.length > 6 ? `<span class="tag" style="background: var(--bg-hover);">+${features.length - 6}</span>` : ''}
          </div>
          ${result.description ? `<div class="result-description">${result.description.slice(0, 100)}...</div>` : ''}
        </div>
      </div>
    `;
  }).join('');

  // Update filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.toLowerCase() === filter ||
      (filter === 'all' && btn.textContent === 'All'));
  });
}

function filterResults(category) {
  renderResults(category);
}

function formatFeature(feature) {
  return feature.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

// ============================================
// 360 VIEWER MODAL
// ============================================
function openViewer(imageName) {
  const modal = document.getElementById('viewerModal');
  modal.classList.add('active');

  document.getElementById('modalImageName').textContent = imageName;

  const result = analysisResults[imageName];
  if (result) {
    document.getElementById('modalTags').innerHTML = result.features.map(f => `
      <span class="tag ${f.category}">${formatFeature(f.feature)}</span>
    `).join('');
    document.getElementById('modalDescription').textContent = result.description || '';
  }

  initModalViewer(imageName);
}

function closeViewer() {
  document.getElementById('viewerModal').classList.remove('active');
  if (modalRenderer) {
    modalRenderer.dispose();
  }
}

function initModalViewer(imageName) {
  const canvas = document.getElementById('modal-canvas');
  const container = canvas.parentElement;

  modalScene = new THREE.Scene();
  modalCamera = new THREE.PerspectiveCamera(modalFov, container.clientWidth / container.clientHeight, 0.1, 1000);
  modalRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  modalRenderer.setSize(container.clientWidth, container.clientHeight);

  const geometry = new THREE.SphereGeometry(500, 60, 40);
  geometry.scale(-1, 1, 1);

  const loader = new THREE.TextureLoader();
  loader.load(CONFIG.framesBase + imageName, (texture) => {
    const material = new THREE.MeshBasicMaterial({ map: texture });
    modalSphere = new THREE.Mesh(geometry, material);
    modalScene.add(modalSphere);
  });

  modalCamera.position.set(0, 0, 0.1);
  modalLon = 0;
  modalLat = 0;

  // Event listeners
  canvas.addEventListener('mousedown', onModalDown);
  canvas.addEventListener('mousemove', onModalMove);
  canvas.addEventListener('mouseup', onModalUp);
  canvas.addEventListener('wheel', onModalWheel);

  animateModal();
}

function animateModal() {
  if (!document.getElementById('viewerModal').classList.contains('active')) return;

  requestAnimationFrame(animateModal);

  const phi = THREE.MathUtils.degToRad(90 - modalLat);
  const theta = THREE.MathUtils.degToRad(modalLon);

  modalCamera.lookAt(
    500 * Math.sin(phi) * Math.cos(theta),
    500 * Math.cos(phi),
    500 * Math.sin(phi) * Math.sin(theta)
  );

  modalCamera.fov = modalFov;
  modalCamera.updateProjectionMatrix();
  modalRenderer.render(modalScene, modalCamera);
}

function onModalDown(e) {
  modalInteracting = true;
  modalStartX = e.clientX;
  modalStartY = e.clientY;
  modalStartLon = modalLon;
  modalStartLat = modalLat;
}

function onModalMove(e) {
  if (!modalInteracting) return;
  modalLon = (modalStartX - e.clientX) * 0.2 + modalStartLon;
  modalLat = (e.clientY - modalStartY) * 0.2 + modalStartLat;
  modalLat = Math.max(-85, Math.min(85, modalLat));
}

function onModalUp() { modalInteracting = false; }

function onModalWheel(e) {
  e.preventDefault();
  modalFov += e.deltaY * 0.05;
  modalFov = Math.max(20, Math.min(100, modalFov));
}

// ============================================
// LOGGING
// ============================================
function log(message, type = 'info') {
  const container = document.getElementById('logEntries');
  const time = new Date().toLocaleTimeString();

  container.innerHTML = `
    <div class="log-entry">
      <span class="log-time">${time}</span>
      <span class="log-${type}">${message}</span>
    </div>
  ` + container.innerHTML;

  // Keep only last 50 entries
  const entries = container.querySelectorAll('.log-entry');
  if (entries.length > 50) {
    entries[entries.length - 1].remove();
  }
}

// ============================================
// DATA MANAGEMENT
// ============================================
function exportData() {
  const data = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    framesBase: CONFIG.framesBase,
    summary: {
      totalImages: images.length,
      analyzedImages: Object.keys(analysisResults).length,
      totalFeatures: Object.values(analysisResults).reduce((sum, r) => sum + (r.features?.length || 0), 0)
    },
    featureCounts: getFeatureCounts(),
    images: analysisResults
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `360db-analysis-${new Date().toISOString().slice(0, 10)}.json`;
  a.click();

  URL.revokeObjectURL(url);
  log('Exported data to JSON', 'success');
}

function getFeatureCounts() {
  const counts = {};
  Object.values(analysisResults).forEach(r => {
    (r.features || []).forEach(f => {
      counts[f.feature] = (counts[f.feature] || 0) + 1;
    });
  });
  return counts;
}

function saveToLocalStorage() {
  localStorage.setItem('360db-results', JSON.stringify(analysisResults));
}

function loadFromLocalStorage() {
  const saved = localStorage.getItem('360db-results');
  if (saved) {
    try {
      analysisResults = JSON.parse(saved);
      log(`Loaded ${Object.keys(analysisResults).length} cached results`, 'info');
    } catch (e) {
      console.error('Failed to load cache:', e);
    }
  }
}

// ============================================
// UTILITIES
// ============================================
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ============================================
// INIT
// ============================================
init();
</script>
</body>
</html>
