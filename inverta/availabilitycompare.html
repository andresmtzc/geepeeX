<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Availability Comparison Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 40px;
      margin-bottom: 20px;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9ff;
    }

    .upload-area:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }

    .upload-area.dragover {
      border-color: #764ba2;
      background: #e8ebff;
      transform: scale(1.02);
    }

    #fileInput {
      display: none;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
      color: #667eea;
    }

    .upload-text {
      font-size: 18px;
      color: #667eea;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .upload-hint {
      font-size: 13px;
      color: #999;
    }

    .selected-file {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      border-radius: 4px;
    }

    .selected-file strong {
      color: #2e7d32;
    }

    .loading {
      text-align: center;
      padding: 30px;
      display: none;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .results {
      display: none;
    }

    .results.active {
      display: block;
    }

    .result-section {
      margin-bottom: 30px;
    }

    .result-header {
      background: #f8f9ff;
      padding: 15px;
      border-left: 4px solid #667eea;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .result-header h2 {
      font-size: 18px;
      color: #667eea;
      margin-bottom: 5px;
    }

    .result-header .count {
      font-size: 14px;
      color: #666;
    }

    .lot-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .lot-item {
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .lot-item:hover {
      background: #eeeeee;
      transform: translateY(-2px);
    }

    .lot-item.sold {
      background: #ffebee;
      border-left: 3px solid #f44336;
    }

    .lot-item.mismatch {
      background: #fff3e0;
      border-left: 3px solid #ff9800;
    }

    .lot-item.mismatch::before {
      content: '‚ö†Ô∏è ';
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 13px;
      opacity: 0.9;
    }

    .error {
      background: #ffebee;
      border-left: 4px solid #f44336;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .error.active {
      display: block;
    }

    .error-title {
      color: #c62828;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .error-message {
      color: #666;
      font-size: 14px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin-top: 20px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 15px;
    }

    .auth-section {
      background: #f8f9ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .auth-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .auth-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ccc;
    }

    .auth-indicator.authenticated {
      background: #4caf50;
    }

    .auth-buttons {
      display: flex;
      gap: 10px;
    }

    .auth-btn {
      padding: 8px 20px;
      font-size: 14px;
      margin: 0;
    }

    .update-btn {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      margin-right: 10px;
      display: inline-block;
    }

    .update-btn:hover {
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .update-btn.danger {
      background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
    }

    .section-actions {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #f0f0f0;
    }

    #loginModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    #loginModal.active {
      display: flex;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .login-card h2 {
      margin-bottom: 20px;
      color: #667eea;
    }

    .login-card input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .login-card input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .login-actions button {
      flex: 1;
      margin: 0;
    }

    .cancel-btn {
      background: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üìä PDF Availability Comparison Tool</h1>
      <p class="subtitle">Upload your inventory PDF to compare against database availability</p>

      <!-- Auth Section -->
      <div class="auth-section">
        <div class="auth-status">
          <div class="auth-indicator" id="authIndicator"></div>
          <span id="authStatus">Not logged in</span>
        </div>
        <div class="auth-buttons">
          <button class="auth-btn" id="loginBtn">Login</button>
          <button class="auth-btn" id="logoutBtn" style="display: none;">Logout</button>
        </div>
      </div>

      <div class="error" id="errorDiv">
        <div class="error-title">Error</div>
        <div class="error-message" id="errorMessage"></div>
      </div>

      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÑ</div>
        <div class="upload-text">Click or drag PDF here</div>
        <div class="upload-hint">Supported format: PDF files with inventory data</div>
        <input type="file" id="fileInput" accept=".pdf" multiple>
      </div>

      <div class="selected-file" id="selectedFile" style="display: none;">
        <strong>Selected:</strong> <span id="fileName"></span>
      </div>

      <button id="compareBtn" style="display: none;">Compare with Database</button>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Processing PDF and comparing with database...</div>
      </div>
    </div>

    <div class="card results" id="results">
      <h2 style="margin-bottom: 20px;">üìà Comparison Results</h2>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="statPdfLots">0</div>
          <div class="stat-label">Lots in PDF (Available)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statDbLots">0</div>
          <div class="stat-label">Lots in DB (Available)</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);">
          <div class="stat-number" id="statSold">0</div>
          <div class="stat-label">Likely Sold (In DB, Not in PDF)</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
          <div class="stat-number" id="statMismatch">0</div>
          <div class="stat-label">Mismatches (In PDF, Sold in DB)</div>
        </div>
      </div>

      <div class="result-section" id="soldSection">
        <div class="result-header">
          <h2>üî¥ Lots Marked Available in DB but NOT in PDF (Likely Sold)</h2>
          <div class="count">These lots should probably be marked as "Sold" in the database</div>
        </div>
        <div class="lot-list" id="soldList"></div>
        <div class="section-actions" id="soldActions" style="display: none;">
          <button class="update-btn danger" id="markSoldBtn" disabled>
            Mark All as Sold (<span id="soldCount">0</span> lots)
          </button>
          <small style="color: #666;">This will update the database and mark these lots as "Sold"</small>
        </div>
      </div>

      <div class="result-section" id="mismatchSection">
        <div class="result-header">
          <h2>‚ö†Ô∏è Lots in PDF but Marked Sold in DB (Mismatches)</h2>
          <div class="count">These lots appear available in the PDF but are marked as sold in the database</div>
        </div>
        <div class="lot-list" id="mismatchList"></div>
        <div class="section-actions" id="mismatchActions" style="display: none;">
          <button class="update-btn" id="markAvailableBtn" disabled>
            Mark All as Available (<span id="mismatchCount">0</span> lots)
          </button>
          <small style="color: #666;">This will update the database and mark these lots as "Available"</small>
        </div>
      </div>

      <button onclick="location.reload()">Upload Another PDF</button>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal">
    <div class="login-card">
      <h2>üîê Login</h2>
      <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
        Login required to update database records
      </p>

      <!-- Step 1: Email -->
      <div id="authStepEmail">
        <input type="email" id="loginEmail" placeholder="Email" />
        <div class="login-actions">
          <button class="cancel-btn" id="cancelLoginBtn">Cancel</button>
          <button id="requestOtpBtn">Send Code</button>
        </div>
      </div>

      <!-- Step 2: OTP Code -->
      <div id="authStepOtp" style="display: none;">
        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
          Code sent to <strong id="otpEmailDisplay"></strong>
        </p>
        <input type="text" id="loginOtp" placeholder="6-digit code" maxlength="6" />
        <div class="login-actions">
          <button class="cancel-btn" id="cancelOtpBtn">Cancel</button>
          <button id="verifyOtpBtn">Verify Code</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Set PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Initialize Supabase
    let supabaseClient = null;
    let currentUser = null;
    let currentLikelySoldLots = [];
    let currentMismatchLots = [];
    let pendingEmail = null;
    const CURRENT_CLIENT = 'inverta'; // Match your client config

    // Load Supabase config
    async function initSupabase() {
      try {
        const response = await fetch('https://la-la.land/sb_config.json');
        if (!response.ok) {
          throw new Error('Failed to load Supabase config');
        }
        const config = await response.json();

        supabaseClient = supabase.createClient(config.url, config.key);
        console.log('‚úÖ Supabase initialized');

        // Check for existing session
        await checkAuth();

        return true;
      } catch (error) {
        console.error('‚ùå Failed to initialize Supabase:', error);
        showError('Failed to connect to database. Please check your internet connection.');
        return false;
      }
    }

    // Check if email is allowed in editors table
    async function isEmailAllowed(email) {
      const { data, error } = await supabaseClient
        .from('editors')
        .select('id')
        .eq('email', email.trim().toLowerCase())
        .eq('client_id', CURRENT_CLIENT)
        .maybeSingle();

      if (error) {
        console.error('Allowlist check failed:', error);
        return false;
      }
      return !!data;
    }

    // Authentication Functions
    async function checkAuth() {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          currentUser = session.user;
          updateAuthUI(true, session.user.email);
        } else {
          currentUser = null;
          updateAuthUI(false);
        }
      } catch (error) {
        console.error('Auth check error:', error);
        currentUser = null;
        updateAuthUI(false);
      }
    }

    function updateAuthUI(isAuthenticated, email = '') {
      const authIndicator = document.getElementById('authIndicator');
      const authStatus = document.getElementById('authStatus');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const markSoldBtn = document.getElementById('markSoldBtn');
      const markAvailableBtn = document.getElementById('markAvailableBtn');

      if (isAuthenticated) {
        authIndicator.classList.add('authenticated');
        authStatus.textContent = `Logged in as ${email}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'block';

        // Enable update buttons if there are lots to update
        if (currentLikelySoldLots.length > 0) {
          markSoldBtn.disabled = false;
        }
        if (currentMismatchLots.length > 0) {
          markAvailableBtn.disabled = false;
        }
      } else {
        authIndicator.classList.remove('authenticated');
        authStatus.textContent = 'Not logged in';
        loginBtn.style.display = 'block';
        logoutBtn.style.display = 'none';
        markSoldBtn.disabled = true;
        markAvailableBtn.disabled = true;
      }
    }

    async function requestOtp(email) {
      try {
        // Check if email is allowed
        const allowed = await isEmailAllowed(email);
        if (!allowed) {
          showError('This email is not authorized to update records');
          return false;
        }

        const { error } = await supabaseClient.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: window.location.origin }
        });

        if (error) throw error;

        pendingEmail = email;
        console.log('‚úÖ OTP sent to', email);
        return true;
      } catch (error) {
        console.error('‚ùå OTP request error:', error);
        if (error.message && error.message.includes('rate limit')) {
          showError('Too many requests. Please wait a few minutes and try again.');
        } else {
          showError(`Failed to send code: ${error.message}`);
        }
        return false;
      }
    }

    async function verifyOtp(token) {
      try {
        const { data, error } = await supabaseClient.auth.verifyOtp({
          email: pendingEmail,
          token,
          type: 'email'
        });

        if (error) throw error;

        currentUser = data.user;
        updateAuthUI(true, data.user.email);
        resetLoginModal();
        document.getElementById('loginModal').classList.remove('active');
        console.log('‚úÖ Logged in successfully');
        return true;
      } catch (error) {
        console.error('‚ùå OTP verification error:', error);
        showError('Invalid or expired code');
        return false;
      }
    }

    function resetLoginModal() {
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginOtp').value = '';
      document.getElementById('authStepEmail').style.display = 'block';
      document.getElementById('authStepOtp').style.display = 'none';
      pendingEmail = null;
    }

    async function logout() {
      try {
        await supabaseClient.auth.signOut();
        currentUser = null;
        updateAuthUI(false);
        console.log('‚úÖ Logged out successfully');
      } catch (error) {
        console.error('‚ùå Logout error:', error);
        showError(`Logout failed: ${error.message}`);
      }
    }

    // Bulk Update Functions
    async function markLotsAsSold(lots) {
      if (!currentUser) {
        showError('You must be logged in to update lots');
        return false;
      }

      if (!confirm(`Are you sure you want to mark ${lots.length} lots as SOLD?\n\nThis will update the database.`)) {
        return false;
      }

      try {
        const lotNames = lots.map(lot => lot.lot_name);

        console.log('Marking as sold:', lotNames);

        const { data, error } = await supabaseClient
          .from('lots')
          .update({ availability: 'Sold' })
          .in('lot_name', lotNames);

        if (error) throw error;

        alert(`‚úÖ Successfully marked ${lots.length} lots as Sold!`);
        console.log('‚úÖ Update successful');

        // Reload to show updated results
        setTimeout(() => location.reload(), 1500);

        return true;
      } catch (error) {
        console.error('‚ùå Update error:', error);

        // Handle specific permission errors
        if (error.code === '42501' || error.message.includes('permission') || error.message.includes('policy')) {
          showError('You do not have permission to update lots. Only authorized editors can modify the database.');
        } else if (error.message.includes('JWT')) {
          showError('Your session has expired. Please log out and log in again.');
        } else {
          showError(`Failed to update lots: ${error.message}`);
        }
        return false;
      }
    }

    async function markLotsAsAvailable(lots) {
      if (!currentUser) {
        showError('You must be logged in to update lots');
        return false;
      }

      if (!confirm(`Are you sure you want to mark ${lots.length} lots as AVAILABLE?\n\nThis will update the database.`)) {
        return false;
      }

      try {
        const lotNames = lots.map(lot => lot.lot_name);

        console.log('Marking as available:', lotNames);

        const { data, error } = await supabaseClient
          .from('lots')
          .update({ availability: 'Available' })
          .in('lot_name', lotNames);

        if (error) throw error;

        alert(`‚úÖ Successfully marked ${lots.length} lots as Available!`);
        console.log('‚úÖ Update successful');

        // Reload to show updated results
        setTimeout(() => location.reload(), 1500);

        return true;
      } catch (error) {
        console.error('‚ùå Update error:', error);

        // Handle specific permission errors
        if (error.code === '42501' || error.message.includes('permission') || error.message.includes('policy')) {
          showError('You do not have permission to update lots. Only authorized editors can modify the database.');
        } else if (error.message.includes('JWT')) {
          showError('Your session has expired. Please log out and log in again.');
        } else {
          showError(`Failed to update lots: ${error.message}`);
        }
        return false;
      }
    }

    // Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const selectedFileDiv = document.getElementById('selectedFile');
    const fileNameSpan = document.getElementById('fileName');
    const compareBtn = document.getElementById('compareBtn');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const errorDiv = document.getElementById('errorDiv');
    const errorMessage = document.getElementById('errorMessage');

    let selectedFiles = [];

    // Initialize on load
    initSupabase();

    // Auth event listeners
    document.getElementById('loginBtn').addEventListener('click', () => {
      resetLoginModal();
      document.getElementById('loginModal').classList.add('active');
    });

    document.getElementById('logoutBtn').addEventListener('click', logout);

    document.getElementById('cancelLoginBtn').addEventListener('click', () => {
      resetLoginModal();
      document.getElementById('loginModal').classList.remove('active');
    });

    document.getElementById('cancelOtpBtn').addEventListener('click', () => {
      resetLoginModal();
      document.getElementById('loginModal').classList.remove('active');
    });

    // Request OTP code
    document.getElementById('requestOtpBtn').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();

      if (!email) {
        showError('Please enter your email');
        return;
      }

      const looksLikeEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if (!looksLikeEmail) {
        showError('Please enter a valid email');
        return;
      }

      const btn = document.getElementById('requestOtpBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Sending...';

      const success = await requestOtp(email);

      if (success) {
        document.getElementById('otpEmailDisplay').textContent = email;
        document.getElementById('authStepEmail').style.display = 'none';
        document.getElementById('authStepOtp').style.display = 'block';
        hideError();
        setTimeout(() => document.getElementById('loginOtp').focus(), 100);
      }

      btn.disabled = false;
      btn.textContent = originalText;
    });

    // Verify OTP code
    document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
      const token = document.getElementById('loginOtp').value.trim();

      if (token.length !== 6) {
        showError('Code must be 6 digits');
        return;
      }

      const btn = document.getElementById('verifyOtpBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Verifying...';

      await verifyOtp(token);

      btn.disabled = false;
      btn.textContent = originalText;
    });

    // Allow Enter key to submit
    document.getElementById('loginEmail').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('requestOtpBtn').click();
      }
    });

    document.getElementById('loginOtp').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('verifyOtpBtn').click();
      }
    });

    // Update button event listeners
    document.getElementById('markSoldBtn').addEventListener('click', () => {
      markLotsAsSold(currentLikelySoldLots);
    });

    document.getElementById('markAvailableBtn').addEventListener('click', () => {
      markLotsAsAvailable(currentMismatchLots);
    });

    // Upload area click
    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    // File selection
    fileInput.addEventListener('change', (e) => {
      handleFileSelect(e.target.files);
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFileSelect(e.dataTransfer.files);
    });

    function handleFileSelect(files) {
      if (!files || files.length === 0) return;

      // Filter for PDF files only
      const pdfFiles = Array.from(files).filter(file =>
        file.name.toLowerCase().endsWith('.pdf')
      );

      if (pdfFiles.length === 0) {
        showError('Please select at least one PDF file');
        return;
      }

      selectedFiles = pdfFiles;
      const fileNames = pdfFiles.map(f => f.name).join(', ');
      fileNameSpan.textContent = `${pdfFiles.length} file(s): ${fileNames}`;
      selectedFileDiv.style.display = 'block';
      compareBtn.style.display = 'block';
      hideError();
    }

    // Compare button
    compareBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;

      compareBtn.disabled = true;
      loading.classList.add('active');
      results.classList.remove('active');
      hideError();

      try {
        await processAndCompareMultiple(selectedFiles);
      } catch (error) {
        console.error('Error processing:', error);
        showError(error.message || 'An error occurred while processing the PDF');
      } finally {
        compareBtn.disabled = false;
        loading.classList.remove('active');
      }
    });

    async function processAndCompareMultiple(files) {
      // Process all PDFs and combine results
      const allResults = [];

      for (const file of files) {
        console.log('\nüìÑ Processing:', file.name);

        // Step 1: Extract fraccionamiento from filename
        const fraccionamiento = extractFraccionamiento(file.name);
        if (!fraccionamiento) {
          console.warn('‚ö†Ô∏è Skipping file (could not extract fraccionamiento):', file.name);
          continue;
        }
        console.log('üìç Fraccionamiento:', fraccionamiento);

        // Step 2: Parse PDF to extract lot numbers
        const pdfLots = await parsePDF(file);
        if (pdfLots.length === 0) {
          console.warn('‚ö†Ô∏è No lots found in PDF:', file.name);
          continue;
        }
        console.log('üìÑ Lots found in PDF:', pdfLots.length, pdfLots.slice(0, 5));

        // Step 3: Query database for lots in this fraccionamiento
        const dbLots = await queryDatabase(fraccionamiento);
        console.log('üíæ Lots found in DB for', fraccionamiento, ':', dbLots.length);

        // Store results for this fraccionamiento
        allResults.push({
          fraccionamiento,
          fileName: file.name,
          pdfLots,
          dbLots
        });
      }

      if (allResults.length === 0) {
        throw new Error('No valid PDFs were processed');
      }

      // Step 4: Compare and display all results
      compareAndDisplayMultiple(allResults);
    }

    async function processAndCompare(file) {
      // Step 1: Extract fraccionamiento from filename
      const fraccionamiento = extractFraccionamiento(file.name);
      if (!fraccionamiento) {
        throw new Error('Could not extract fraccionamiento from filename. Expected format: "PROJECT_FRACCIONAMIENTO DATE.pdf"');
      }
      console.log('üìç Fraccionamiento:', fraccionamiento);

      // Step 2: Parse PDF to extract lot numbers
      const pdfLots = await parsePDF(file);
      if (pdfLots.length === 0) {
        throw new Error('No lots found in PDF. Make sure the PDF contains lot data in format MZ##L##');
      }
      console.log('üìÑ Lots found in PDF:', pdfLots.length, pdfLots);

      // Step 3: Query database for lots in this fraccionamiento
      const dbLots = await queryDatabase(fraccionamiento);
      console.log('üíæ Lots found in DB:', dbLots.length);

      // Step 4: Compare and generate results
      compareAndDisplay(pdfLots, dbLots, fraccionamiento);
    }

    function extractFraccionamiento(filename) {
      // Format: "LOMAS MEDITERRANEO C_MARSELLA 14ENE2026.pdf"
      // We want to extract "MARSELLA" (between underscore and date/space)

      const match = filename.match(/_([A-Z]+)\s/i);
      if (match) {
        return match[1].toUpperCase();
      }

      // Try alternative pattern without space before date
      const match2 = filename.match(/_([A-Z]+)/i);
      if (match2) {
        return match2[1].toUpperCase();
      }

      return null;
    }

    async function parsePDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let allText = '';

      // Extract text from all pages
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        allText += pageText + ' ';
      }

      console.log('üìù Extracted PDF text length:', allText.length);

      // Find all lot numbers in format MZ##L##
      const lotPattern = /MZ(\d+)L(\d+)/gi;
      const matches = [...allText.matchAll(lotPattern)];

      const lots = matches.map(match => {
        const manzana = match[1].padStart(2, '0');
        const lote = match[2].padStart(2, '0');
        return {
          original: match[0],
          manzana: parseInt(match[1]),
          lote: parseInt(match[2]),
          formatted: `${manzana}-${lote}` // Format: "24-09"
        };
      });

      // Remove duplicates
      const uniqueLots = Array.from(new Map(lots.map(lot => [lot.formatted, lot])).values());

      return uniqueLots;
    }

async function queryDatabase(fraccionamiento) {
  if (!supabaseClient) {
    throw new Error('Supabase not initialized');
  }

  const { data, error } = await supabaseClient
    .from('lots')
    .select('lot_name, availability, fraccionamiento, client_id')
    .eq('client_id', CURRENT_CLIENT)  // ‚¨ÖÔ∏è ADD THIS LINE
    .ilike('fraccionamiento', fraccionamiento);

  if (error) {
    throw new Error(`Database query failed: ${error.message}`);
  }

  console.log('üíæ Raw DB results for fraccionamiento "' + fraccionamiento + '":', data.length);
  if (data && data.length > 0) {
    console.log('üíæ Sample DB records:', data.slice(0, 3));
  }

  return data || [];
}

    function compareAndDisplayMultiple(allResults) {
      // Combine all results from multiple PDFs
      let totalPdfLots = 0;
      let totalDbLots = 0;
      let allLikelySold = [];
      let allMismatches = [];

      allResults.forEach(result => {
        const { fraccionamiento, pdfLots, dbLots } = result;

        const pdfLotSet = new Set(pdfLots.map(lot => lot.formatted));

        // Separate DB lots into Available and Sold
        const dbAvailableLots = [];
        const dbSoldLots = [];

        dbLots.forEach(lot => {
          // Extract manzana-lote from lot_name (e.g., "lotinverta24-09" -> "24-09")
          const match = lot.lot_name.match(/lotinverta[p]?(\d+-\d+)/i);
          if (match) {
            const formatted = match[1];
            const lotInfo = {
              ...lot,
              formatted: formatted,
              displayName: `${lot.fraccionamiento} ${formatted}` // e.g., "MARSELLA 10-29"
            };

            if (lot.availability && lot.availability.toLowerCase() === 'sold') {
              dbSoldLots.push(lotInfo);
            } else {
              dbAvailableLots.push(lotInfo);
            }
          }
        });

        console.log('üîç Comparison for', fraccionamiento + ':');
        console.log('  PDF lots:', Array.from(pdfLotSet));
        console.log('  DB Available lots:', dbAvailableLots.map(l => `${l.formatted} (${l.availability})`));
        console.log('  DB Sold lots:', dbSoldLots.map(l => `${l.formatted} (${l.availability})`));

        // Find lots that are Available in DB but NOT in PDF (likely sold)
        const likelySold = dbAvailableLots.filter(lot => !pdfLotSet.has(lot.formatted));

        // Find lots that are in PDF but marked Sold in DB (mismatches - edge case)
        const mismatches = dbSoldLots.filter(lot => pdfLotSet.has(lot.formatted));

        console.log('üìä Results for', fraccionamiento + ':');
        console.log('  Likely sold:', likelySold.length, likelySold.map(l => l.formatted));
        console.log('  Mismatches:', mismatches.length, mismatches.map(l => l.formatted));

        totalPdfLots += pdfLots.length;
        totalDbLots += dbAvailableLots.length;
        allLikelySold.push(...likelySold);
        allMismatches.push(...mismatches);
      });

      // Update stats
      document.getElementById('statPdfLots').textContent = totalPdfLots;
      document.getElementById('statDbLots').textContent = totalDbLots;
      document.getElementById('statSold').textContent = allLikelySold.length;
      document.getElementById('statMismatch').textContent = allMismatches.length;

      // Display sold lots
      const soldList = document.getElementById('soldList');
      soldList.innerHTML = '';
      if (allLikelySold.length === 0) {
        soldList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No discrepancies found! All available lots in DB match the PDF.</div></div>';
      } else {
        allLikelySold.forEach(lot => {
          const div = document.createElement('div');
          div.className = 'lot-item sold';
          div.textContent = lot.displayName; // Shows "MARSELLA 10-29" instead of "lotinverta10-29"
          div.title = `DB: ${lot.lot_name} | Availability: ${lot.availability}`;
          soldList.appendChild(div);
        });
      }

      // Display mismatches
      const mismatchList = document.getElementById('mismatchList');
      mismatchList.innerHTML = '';
      if (allMismatches.length === 0) {
        mismatchList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No mismatches found.</div></div>';
      } else {
        allMismatches.forEach(lot => {
          const div = document.createElement('div');
          div.className = 'lot-item mismatch';
          div.textContent = lot.displayName; // Shows "MARSELLA 10-29" instead of "lotinverta10-29"
          div.title = `In PDF but marked Sold in DB | DB: ${lot.lot_name} | Availability: ${lot.availability}`;
          mismatchList.appendChild(div);
        });
      }

      // Store lots for update functions
      currentLikelySoldLots = allLikelySold;
      currentMismatchLots = allMismatches;

      // Update button counts and visibility
      document.getElementById('soldCount').textContent = allLikelySold.length;
      document.getElementById('mismatchCount').textContent = allMismatches.length;

      const soldActions = document.getElementById('soldActions');
      const mismatchActions = document.getElementById('mismatchActions');

      if (allLikelySold.length > 0) {
        soldActions.style.display = 'block';
      }

      if (allMismatches.length > 0) {
        mismatchActions.style.display = 'block';
      }

      // Update auth UI to enable/disable buttons based on login status
      if (currentUser) {
        updateAuthUI(true, currentUser.email);
      }

      // Show results
      results.classList.add('active');
    }

    function compareAndDisplay(pdfLots, dbLots, fraccionamiento) {
      // Convert PDF lots to database format (lotinverta##-## or lotinvertap##-##)
      const pdfLotSet = new Set(pdfLots.map(lot => lot.formatted));

      // Separate DB lots into Available and Sold
      const dbAvailableLots = [];
      const dbSoldLots = [];

      dbLots.forEach(lot => {
        // Extract manzana-lote from lot_name (e.g., "lotinverta24-09" -> "24-09")
        const match = lot.lot_name.match(/lotinverta[p]?(\d+-\d+)/i);
        if (match) {
          const formatted = match[1];
          const lotInfo = {
            ...lot,
            formatted: formatted,
            displayName: `${lot.fraccionamiento} ${formatted}` // e.g., "MARSELLA 10-29"
          };

          if (lot.availability && lot.availability.toLowerCase() === 'sold') {
            dbSoldLots.push(lotInfo);
          } else {
            dbAvailableLots.push(lotInfo);
          }
        }
      });

      console.log('üîç Comparison:');
      console.log('  PDF lots:', Array.from(pdfLotSet));
      console.log('  DB Available lots:', dbAvailableLots.map(l => `${l.formatted} (${l.availability})`));
      console.log('  DB Sold lots:', dbSoldLots.map(l => `${l.formatted} (${l.availability})`));

      // Find lots that are Available in DB but NOT in PDF (likely sold)
      const likelySold = dbAvailableLots.filter(lot => !pdfLotSet.has(lot.formatted));

      // Find lots that are in PDF but marked Sold in DB (mismatches - edge case)
      const mismatches = dbSoldLots.filter(lot => pdfLotSet.has(lot.formatted));

      console.log('üìä Results:');
      console.log('  Likely sold:', likelySold.length, likelySold.map(l => l.formatted));
      console.log('  Mismatches:', mismatches.length, mismatches.map(l => l.formatted));

      // Update stats
      document.getElementById('statPdfLots').textContent = pdfLots.length;
      document.getElementById('statDbLots').textContent = dbAvailableLots.length;
      document.getElementById('statSold').textContent = likelySold.length;
      document.getElementById('statMismatch').textContent = mismatches.length;

      // Display sold lots
      const soldList = document.getElementById('soldList');
      soldList.innerHTML = '';
      if (likelySold.length === 0) {
        soldList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No discrepancies found! All available lots in DB match the PDF.</div></div>';
      } else {
        likelySold.forEach(lot => {
          const div = document.createElement('div');
          div.className = 'lot-item sold';
          div.textContent = lot.displayName; // Shows "MARSELLA 10-29" instead of "lotinverta10-29"
          div.title = `DB: ${lot.lot_name} | Availability: ${lot.availability}`;
          soldList.appendChild(div);
        });
      }

      // Display mismatches
      const mismatchList = document.getElementById('mismatchList');
      mismatchList.innerHTML = '';
      if (mismatches.length === 0) {
        mismatchList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>No mismatches found.</div></div>';
      } else {
        mismatches.forEach(lot => {
          const div = document.createElement('div');
          div.className = 'lot-item mismatch';
          div.textContent = lot.displayName; // Shows "MARSELLA 10-29" instead of "lotinverta10-29"
          div.title = `In PDF but marked Sold in DB | DB: ${lot.lot_name} | Availability: ${lot.availability}`;
          mismatchList.appendChild(div);
        });
      }

      // Store lots for update functions
      currentLikelySoldLots = likelySold;
      currentMismatchLots = mismatches;

      // Update button counts and visibility
      document.getElementById('soldCount').textContent = likelySold.length;
      document.getElementById('mismatchCount').textContent = mismatches.length;

      const soldActions = document.getElementById('soldActions');
      const mismatchActions = document.getElementById('mismatchActions');

      if (likelySold.length > 0) {
        soldActions.style.display = 'block';
      }

      if (mismatches.length > 0) {
        mismatchActions.style.display = 'block';
      }

      // Update auth UI to enable/disable buttons based on login status
      if (currentUser) {
        updateAuthUI(true, currentUser.email);
      }

      // Show results
      results.classList.add('active');
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorDiv.classList.add('active');
    }

    function hideError() {
      errorDiv.classList.remove('active');
    }
  </script>
</body>
</html>
